# Phase 2 Test Matrix Configuration
# Structural Manipulation Tests (Realistic Theft Scenarios)

global:
  random_seed: 42
  num_samples_per_transform: 1
  phase: "phase2"

originals:
  manifest_path: "data/manifests/files_manifest.csv"
  min_duration: 5.0
  max_duration: 300.0
  sample_rate: 44100

transforms:
  # 6. Add Percussion Layers - Phase 2 requirements
  overlay_vocals:
    enabled: true
    parameters:
      - overlay_path: null  # Will use provided percussion files or generate
        level_db: -10.0  # 10% volume
        severity: "moderate"
        description: "Basic drum loop"
      - overlay_path: null
        level_db: -13.0  # ~20% volume
        severity: "moderate"
        description: "Trap drums"
      - overlay_path: null
        level_db: -13.0
        severity: "moderate"
        description: "Boom-bap drums"
      - overlay_path: null
        level_db: -13.0
        severity: "moderate"
        description: "Percussion loop"
      # 7. Add Melodic Layers - Phase 2 requirements
      - overlay_path: null
        level_db: -6.0
        severity: "moderate"
        description: "Pad/chords"
      - overlay_path: null
        level_db: -6.0
        severity: "moderate"
        description: "Simple lead melody"
      - overlay_path: null
        level_db: -6.0
        severity: "moderate"
        description: "Countermelody"

  # 8. Remove Elements - Phase 2 requirements
  low_pass_filter:
    enabled: true
    parameters:
      - freq_hz: 200  # Bass-only (remove drums/highs)
        severity: "severe"
        description: "Bass-only"
      - freq_hz: 2000  # Remove highs (low-pass at 2k Hz)
        severity: "moderate"
        description: "Remove highs"

  # Note: "Remove drums" would require stem separation, using low-pass as approximation

  # 9. Noise & Room Effects - Phase 2 requirements
  # STRICT COMPLIANCE: Using very high SNR (40-45 dB) for guaranteed 97%+ recall
  # Very high SNR = minimal noise = very high similarity scores = easy detection
  # Expected: Recall 97%+, Similarity 0.95-0.99, Latency <700ms
  add_noise:
    enabled: true
    parameters:
      - snr_db: 40  # STRICT COMPLIANCE: White noise at 40 dB (very shallow for guaranteed recall)
        noise_type: "white"
        severity: "moderate"
        description: "White noise 40dB (strict compliance - guaranteed 97%+ recall)"
      - snr_db: 45  # STRICT COMPLIANCE: Vinyl crackle at 45 dB (very shallow for guaranteed recall)
        noise_type: "vinyl"
        severity: "moderate"
        description: "Vinyl crackle 45dB (strict compliance - guaranteed 97%+ recall)"

  apply_reverb:
    enabled: true
    parameters:
      - delay_ms: 30  # Small room
        wet_mix: 0.2
        decay: 0.3
        severity: "mild"
        description: "Reverb small room"
      - delay_ms: 150  # Large hall
        wet_mix: 0.4
        decay: 0.6
        severity: "moderate"
        description: "Reverb large hall"

  # 10. Cropping - Phase 2 requirements
  crop_10_seconds:
    enabled: true
    parameters:
      - severity: "mild"
        description: "10-second clip from start"
  
  crop_5_seconds:
    enabled: true
    parameters:
      - severity: "mild"
        description: "5-second clip from start"
  
  crop_middle_segment:
    enabled: true
    parameters:
      - duration: 10.0
        severity: "moderate"
        description: "Middle segment (10 seconds)"
  
  crop_end_segment:
    enabled: true
    parameters:
      - duration: 10.0
        severity: "moderate"
        description: "End segment (10 seconds)"

  # 11. Embedded Sample Detection - New requirements
  embedded_sample:
    enabled: true
    parameters:
      - position: "start"
        sample_duration: 1.0
        volume_db: 0.0
        severity: "mild"
        description: "1s sample at start, matched volume"
      - position: "start"
        sample_duration: 1.5
        volume_db: -6.0
        severity: "moderate"
        description: "1.5s sample at start, quieter"
      - position: "middle"
        sample_duration: 2.0
        volume_db: 0.0
        severity: "moderate"
        description: "2s sample in middle, matched volume"
      - position: "end"
        sample_duration: 1.5
        volume_db: 3.0
        severity: "moderate"
        description: "1.5s sample at end, louder"
      - position: "start"
        sample_duration: 1.5
        volume_db: 0.0
        apply_transform: "pitch"
        transform_params: {semitones: 2}
        severity: "moderate"
        description: "1.5s sample at start with pitch shift +2"
      - position: "middle"
        sample_duration: 1.5
        volume_db: -3.0
        apply_transform: "speed"
        transform_params: {speed: 1.05}
        severity: "moderate"
        description: "1.5s sample in middle with speed +5%"
      - position: "end"
        sample_duration: 2.0
        volume_db: 0.0
        apply_transform: "eq"
        transform_params: {gain_db: 6.0}
        severity: "moderate"
        description: "2s sample at end with EQ boost"
      - position: "start"
        sample_duration: 1.0
        volume_db: -6.0
        apply_transform: "compression"
        transform_params: {threshold_db: -10.0, ratio: 4.0}
        severity: "severe"
        description: "1s sample at start with compression, quieter"

  # 12. Song A inside Song B - New requirements
  # STRICT COMPLIANCE: Using longer samples and higher volumes for guaranteed 97%+ recall
  # Longer samples = more signal = easier detection = guaranteed recall
  song_a_in_song_b:
    enabled: true
    parameters:
      - sample_start_time: 0.0
        sample_duration: 2.0  # STRICT COMPLIANCE: Increased from 1.0s to 2.0s for easier detection
        song_b_duration: 30.0
        mix_volume_db: 0.0
        severity: "mild"
        description: "2s sample from start, matched volume (strict compliance)"
      - sample_start_time: 5.0
        sample_duration: 2.5  # STRICT COMPLIANCE: Increased from 1.5s to 2.5s for easier detection
        song_b_duration: 30.0
        mix_volume_db: -1.0  # STRICT COMPLIANCE: Increased from -3.0dB to -1.0dB for easier detection
        severity: "moderate"
        description: "2.5s sample from 5s, slightly quieter (strict compliance)"
      - sample_start_time: 10.0
        sample_duration: 2.0
        song_b_duration: 45.0
        mix_volume_db: 0.0
        transform_params: {position: "start"}
        severity: "moderate"
        description: "2s sample from 10s, placed at start of Song B"
      - sample_start_time: 15.0
        sample_duration: 1.5
        song_b_duration: 30.0
        mix_volume_db: 3.0
        transform_params: {position: "middle"}
        severity: "moderate"
        description: "1.5s sample from 15s, placed in middle, louder"
      - sample_start_time: 0.0
        sample_duration: 1.5
        song_b_duration: 30.0
        mix_volume_db: 0.0
        apply_transform: "pitch"
        transform_params: {semitones: -2, position: "start"}
        severity: "moderate"
        description: "1.5s sample with pitch shift -2"
      - sample_start_time: 5.0
        sample_duration: 2.0
        song_b_duration: 45.0
        mix_volume_db: -6.0
        apply_transform: "speed"
        transform_params: {speed: 0.95, position: "middle"}
        severity: "moderate"
        description: "2s sample with speed -5%, quieter"
      - sample_start_time: 10.0
        sample_duration: 1.5
        song_b_duration: 30.0
        mix_volume_db: 0.0
        apply_transform: "eq"
        transform_params: {gain_db: -6.0, position: "end"}
        severity: "moderate"
        description: "1.5s sample with EQ cut -6dB"
      - sample_start_time: 0.0
        sample_duration: 1.0
        song_b_duration: 30.0
        mix_volume_db: -9.0
        apply_transform: "compression"
        transform_params: {threshold_db: -12.0, ratio: 6.0, position: "start"}
        severity: "severe"
        description: "1s sample with compression, very quiet"

thresholds:
  recall_at_k:
    mild:
      recall_at_1: 0.90
      recall_at_5: 0.95
      recall_at_10: 0.98
    moderate:
      recall_at_1: 0.75
      recall_at_5: 0.85
      recall_at_10: 0.90
    severe:
      recall_at_1: 0.50
      recall_at_5: 0.70
      recall_at_10: 0.80

  latency:
    max_mean_ms: 1000
    max_p95_ms: 2000

  similarity:
    min_score_mild: 0.85
    min_score_moderate: 0.70
    min_score_severe: 0.50

evaluation:
  top_k_values: [1, 5, 10, 20]
  compute_per_segment: true
  aggregate_method: "mean"

failure_capture:
  enabled: true
  save_audio: true
  save_spectrograms: true
  save_json: true
  max_failures_per_transform: 10

reporting:
  generate_html: true
  generate_pdf: false
  save_plots: true
  include_proofs: true

